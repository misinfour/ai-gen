# 仓库分发逻辑修复说明

## 修复内容

### 1. 日志存储结构优化

**问题**: 当前日志存储直接以日期开头的目录结构不符合需求

**修复**: 
- 修改本地仓库路径模板为: `{base_path}/backup/{repo_name}/{language_path}/{category}/{year}/{month}/{day}`
- 现在日志结构为: `logs/backup/5yxy5.com/src/zh-CN/strategy/2025/09/24`

### 2. 远程仓库多语言路径管理

**问题**: 需要正确管理远程仓库的多语言版本位置

**修复**:
- 保持远程仓库路径模板为: `{base_path}/{language_path}/{category}/{year}/{month}/{day}`
- 现在路径结构为: 
  - 主语言(zh-tw): `src/strategy/2025/09/24`
  - 非主语言(zh-cn): `src/zh-CN/strategy/2025/09/24`

### 3. 备份机制实现

**问题**: 需要备份远程仓库的完整内容

**修复**:
- 实现备份逻辑：本地仓库备份远程仓库的完整路径结构
- 备份路径: `logs/backup/{远程仓库名}/{远程仓库完整路径结构}`
- 支持多语言版本的完整备份

### 4. 文章提交时机控制

**问题**: 每个语言版本都会触发提交，导致多次部署

**修复**:
- 只有最后一个语言的最后一篇文章才会触发最终提交
- 确保所有语言文章生成完成后才触发提交和上传操作

### 5. 自动部署逻辑

**问题**: 缺少最后一篇文章的自动部署触发

**修复**:
- 在最后一篇文章的最后一个语言版本时触发自动部署
- 通过 `is_final_commit` 参数控制是否跳过 CI

## 修改的文件

### 1. `config.json`
- 修改本地仓库路径模板
- 恢复远程仓库的多语言路径模板

### 2. `repo_manager.py`
- 重写 `generate_target_path()` 方法，支持仓库名称变量
- 重写 `upload_to_local_repository()` 方法，实现备份功能
- 重写 `upload_article_to_all_repositories()` 方法，实现正确的分发逻辑

### 3. `article_generator.py`
- 恢复 `ASSETS_DIR` 定义为按日期组织的临时目录结构
- 修改 `generate_markdown()` 方法，实现统一提交时机控制
- 添加 `upload_and_backup_article()` 方法，实现统一上传和备份
- 修改文件存储逻辑，先临时存储，后统一处理

### 4. `process_articles.py`
- 在函数结尾添加清理临时目录的逻辑
- 确保所有文章处理完成后删除临时目录

## 新的工作流程

1. **临时存储**: 文章先在 `logs/2025/09/25/` 目录中临时存放
2. **文章生成**: 正常处理文章生成，为每个语言生成文章
3. **统一提交**: 当一篇文章的所有语言版本全部生成完成后，才开始提交和上传
4. **远程上传**: 将文章上传到对应的远程仓库
5. **本地备份**: 上传成功后，复制备份到对应的备份目录
6. **多仓库备份**: 如果文章上传到多个网站，每个网站的备份目录都需要备份
7. **自动部署**: 每个仓库的最后一篇文章触发自动部署
8. **清理临时目录**: 最后提交本地仓库前删除临时目录和其中的所有文件

## 预期效果

- ✅ 日志结构按网站分类存储
- ✅ 远程仓库正确管理多语言版本路径
- ✅ 文章正确分发到对应仓库
- ✅ 本地仓库完整备份远程仓库内容
- ✅ 临时文件自动清理
- ✅ 提交时机控制，避免多次部署
- ✅ 最后一篇文章触发自动部署

## 测试验证

运行测试脚本验证了以下功能：
- 路径生成正确
- 临时存储路径正确
- 仓库分离逻辑正确
- 配置加载正常

所有修改已完成并通过测试验证。
