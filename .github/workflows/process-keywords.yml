name: å…³é”®è¯æ–‡ç« æ ‡é¢˜å¤„ç†å·¥ä½œæµ

on:
  # å®šæ—¶è§¦å‘ï¼ˆæ¯å¤©åŒ—äº¬æ—¶é—´0ç‚¹ï¼‰
  # schedule:
  # - cron: '0 16 * * *'
  
  # æ‰‹åŠ¨è§¦å‘ï¼ˆç”¨äºæµ‹è¯•ï¼‰
  workflow_dispatch:
    inputs:
      max_process_count:
        description: 'æœ€å¤§å¤„ç†å…³é”®è¯æ•°é‡ï¼ˆç•™ç©ºè¡¨ç¤ºå¤„ç†æ‰€æœ‰ï¼‰'
        required: false
        type: string
      max_rank_count:
        description: 'æœ€å¤§å¤„ç†æ’è¡Œæ•°é‡ï¼ˆå‰Nåï¼Œç•™ç©ºè¡¨ç¤ºä½¿ç”¨é»˜è®¤å€¼ï¼Œæœ€å¤§10000ï¼‰'
        required: false
        type: string
      force_restart:
        description: 'å¼ºåˆ¶é‡æ–°å¼€å§‹å¤„ç†'
        required: false
        default: false
        type: boolean

jobs:
  process-keywords:
    runs-on: ubuntu-latest
    timeout-minutes: 120  # 2å°æ—¶è¶…æ—¶
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GH_PAT || github.token }}
      
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: åˆ›å»ºé…ç½®æ–‡ä»¶
      run: |
        # åªæœ‰åœ¨config.jsonä¸å­˜åœ¨æ—¶æ‰åˆ›å»ºé…ç½®æ–‡ä»¶
        if [ ! -f "config.json" ]; then
          echo "config.jsonä¸å­˜åœ¨ï¼Œæ­£åœ¨åˆ›å»ºé…ç½®æ–‡ä»¶..."
          cat > config.json << EOF
        {
          "default_platform": "groq",
          "platforms": {
            "groq": {
              "name": "Groq",
              "base_url": "https://api.groq.com/openai/v1/chat/completions",
              "proxy_url": "https://m3u8-player.5yxy5.com/api/forward/https://api.groq.com/openai/v1/chat/completions",
              "models": {
                "default": "deepseek-r1-distill-llama-70b",
                "available": [
                  "deepseek-r1-distill-llama-70b",
                  "llama-3.1-70b-versatile",
                  "llama-3.1-8b-instant",
                  "mixtral-8x7b-32768"
                ]
              },
              "api_keys": [
                "${{ secrets.GROQ_API_KEY_1 }}",
                "${{ secrets.GROQ_API_KEY_2 }}",
                "${{ secrets.GROQ_API_KEY_3 }}",
                "${{ secrets.GROQ_API_KEY_4 }}",
                "${{ secrets.GROQ_API_KEY_5 }}",
                "${{ secrets.GROQ_API_KEY_6 }}"
              ],
              "headers": {
                "Content-Type": "application/json"
              },
              "auth_type": "bearer",
              "timeout": 60,
              "max_retries": 20
            },
            "openai": {
              "name": "OpenAI",
              "base_url": "https://api.openai.com/v1/chat/completions",
              "proxy_url": "https://m3u8-player.5yxy5.com/api/forward/https://api.openai.com/v1/chat/completions",
              "models": {
                "default": "gpt-3.5-turbo",
                "available": [
                  "gpt-3.5-turbo",
                  "gpt-3.5-turbo-16k",
                  "gpt-4",
                  "gpt-4-turbo",
                  "gpt-4o",
                  "gpt-4o-mini"
                ]
              },
              "api_keys": [
                "${{ secrets.OPENAI_API_KEY }}"
              ],
              "headers": {
                "Content-Type": "application/json"
              },
              "auth_type": "bearer",
              "timeout": 60,
              "max_retries": 20
            },
            "gemini": {
              "name": "Google Gemini",
              "base_url": "https://generativelanguage.googleapis.com/v1beta/models",
              "proxy_url": "https://m3u8-player.5yxy5.com/api/forward/https://generativelanguage.googleapis.com/v1beta/models",
              "models": {
                "default": "gemini-1.5-flash",
                "available": [
                  "gemini-1.5-flash",
                  "gemini-1.5-pro",
                  "gemini-1.0-pro"
                ]
              },
              "api_keys": [
                "${{ secrets.GEMINI_API_KEY }}"
              ],
              "headers": {
                "Content-Type": "application/json"
              },
              "auth_type": "api_key",
              "timeout": 60,
              "max_retries": 20
            },
            "claude": {
              "name": "Anthropic Claude",
              "base_url": "https://api.anthropic.com/v1/messages",
              "proxy_url": "https://m3u8-player.5yxy5.com/api/forward/https://api.anthropic.com/v1/messages",
              "models": {
                "default": "claude-3-sonnet-20240229",
                "available": [
                  "claude-3-sonnet-20240229",
                  "claude-3-opus-20240229",
                  "claude-3-haiku-20240307"
                ]
              },
              "api_keys": [
                "${{ secrets.CLAUDE_API_KEY }}"
              ],
              "headers": {
                "Content-Type": "application/json",
                "anthropic-version": "2023-06-01"
              },
              "auth_type": "x-api-key",
              "timeout": 60,
              "max_retries": 20
            }
          },
          "settings": {
            "use_proxy": true,
            "temperature": 0.6,
            "max_tokens": 10000,
            "top_p": 0.95,
            "stream": false
          },
          "kv_storage": {
            "account_id": "${{ secrets.CLOUDFLARE_ACCOUNT_ID }}",
            "namespace_id": "${{ secrets.CLOUDFLARE_NAMESPACE_ID }}",
            "api_token": "${{ secrets.CLOUDFLARE_API_TOKEN }}"
          },
          "prompts": {
            "zh-cn": {
              "name": "ç®€ä½“ä¸­æ–‡æç¤ºè¯",
              "template": "${{ secrets.ZH_CN_PROMPT_TEMPLATE }}"
            },
            "zh-tw": {
              "name": "ç¹é«”ä¸­æ–‡æç¤ºè©",
              "template": "${{ secrets.ZH_TW_PROMPT_TEMPLATE }}"
            }
          },
          "google_seo_article_title_prompt": {
            "zh-cn": {
              "name": "ç®€ä½“ä¸­æ–‡æç¤ºè¯",
              "template": "${{ secrets.GOOGLE_SEO_ARTICLE_TITLE_PROMPT_ZH_CN }}"
            },
            "zh-tw": {
              "name": "ç¹é«”ä¸­æ–‡æç¤ºè©",
              "template": "${{ secrets.GOOGLE_SEO_ARTICLE_TITLE_PROMPT_ZH_TW }}"
            }
          }
        }
        EOF
        else
          echo "config.jsonå·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»ºé…ç½®æ–‡ä»¶"
        fi
        
    - name: è¿è¡Œå…³é”®è¯å¤„ç†è„šæœ¬
      id: process-keywords
      run: |
        # è®¾ç½®ç¯å¢ƒå˜é‡
        export PYTHONUNBUFFERED=1
        
        # è·å–å¤„ç†å‚æ•°
        MAX_PROCESS_COUNT="${{ github.event.inputs.max_process_count }}"
        MAX_RANK_COUNT="${{ github.event.inputs.max_rank_count }}"
        
        echo "å¼€å§‹å¤„ç†å…³é”®è¯æ–‡ç« æ ‡é¢˜..."
        echo "æœ€å¤§å¤„ç†å…³é”®è¯æ•°é‡: ${MAX_PROCESS_COUNT:-'æ— é™åˆ¶'}"
        echo "æœ€å¤§å¤„ç†æ’è¡Œæ•°é‡: ${MAX_RANK_COUNT:-'ä½¿ç”¨é»˜è®¤å€¼'}"
        echo "è§¦å‘æ–¹å¼: ${{ github.event_name }}"
        echo "è¿è¡Œæ—¶é—´: $(date)"
        
        # æ„å»ºå‘½ä»¤å‚æ•°
        CMD_ARGS=""
        
        if [ -n "$MAX_PROCESS_COUNT" ]; then
          CMD_ARGS="$CMD_ARGS --max-count $MAX_PROCESS_COUNT"
        fi
        
        if [ -n "$MAX_RANK_COUNT" ]; then
          CMD_ARGS="$CMD_ARGS --max-rank $MAX_RANK_COUNT"
        fi
        
        # è¿è¡Œå…³é”®è¯å¤„ç†è„šæœ¬
        python -c "
        import sys
        sys.path.append('.')
        
        # å¯¼å…¥å¿…è¦çš„æ¨¡å—
        from process_keywords import process_keywords
        import json
        from datetime import datetime
        
        try:
            # è§£æå‚æ•°
            max_count = None
            max_rank = None
            force_restart = '${{ github.event.inputs.force_restart }}' == 'true'
            
            # æ£€æŸ¥æ˜¯å¦æœ‰MAX_PROCESS_COUNTå€¼
            max_process_str = '$MAX_PROCESS_COUNT'
            if max_process_str and max_process_str.strip():
                try:
                    max_count = int(max_process_str)
                    print(f'è§£æåˆ° max_count: {max_count}')
                except ValueError:
                    print(f'è­¦å‘Š: æ— æ³•å°† {max_process_str} è½¬æ¢ä¸ºæ•´æ•°ï¼Œä½¿ç”¨é»˜è®¤å€¼ None')
            
            # æ£€æŸ¥æ˜¯å¦æœ‰MAX_RANK_COUNTå€¼
            max_rank_str = '$MAX_RANK_COUNT'
            if max_rank_str and max_rank_str.strip():
                try:
                    max_rank = int(max_rank_str)
                    print(f'è§£æåˆ° max_rank: {max_rank}')
                except ValueError:
                    print(f'è­¦å‘Š: æ— æ³•å°† {max_rank_str} è½¬æ¢ä¸ºæ•´æ•°ï¼Œä½¿ç”¨é»˜è®¤å€¼ None')
            
            # è¿è¡Œå¤„ç†è„šæœ¬
            result = process_keywords(max_count, max_rank, force_restart)
            
            if result is True:
                print('âœ… å…³é”®è¯å¤„ç†å®Œæˆ')
                
                # è®¾ç½®æˆåŠŸçŠ¶æ€
                with open('process_result.json', 'w', encoding='utf-8') as f:
                    json.dump({
                        'status': 'success',
                        'timestamp': datetime.now().isoformat(),
                        'max_process_count': max_count,
                        'max_rank_count': max_rank,
                        'force_restart': force_restart
                    }, f, ensure_ascii=False, indent=2)
            elif result == 'circuit_breaker':
                print('ğŸ”¥ å…³é”®è¯å¤„ç†è§¦å‘ç†”æ–­æœºåˆ¶ï¼ˆAPIæœåŠ¡å¼‚å¸¸ï¼‰')
                
                # ç†”æ–­çŠ¶æ€
                with open('process_result.json', 'w', encoding='utf-8') as f:
                    json.dump({
                        'status': 'circuit_breaker',
                        'message': 'å…³é”®è¯å¤„ç†è§¦å‘ç†”æ–­æœºåˆ¶ï¼ŒAPIæœåŠ¡å¼‚å¸¸ï¼Œéœ€è¦ç­‰å¾…åé‡è¯•',
                        'timestamp': datetime.now().isoformat(),
                        'max_process_count': max_count,
                        'max_rank_count': max_rank,
                        'force_restart': force_restart
                    }, f, ensure_ascii=False, indent=2)
            else:
                print('âš ï¸ å…³é”®è¯å¤„ç†å¼‚å¸¸ç»ˆæ­¢ï¼ˆKVå­˜å‚¨å¤±è´¥æˆ–å…¶ä»–é—®é¢˜ï¼‰')
                
                # è®¾ç½®è­¦å‘ŠçŠ¶æ€ï¼Œä½†ä¸æŠ›å‡ºå¼‚å¸¸
                with open('process_result.json', 'w', encoding='utf-8') as f:
                    json.dump({
                        'status': 'warning',
                        'message': 'å¤„ç†å¼‚å¸¸ç»ˆæ­¢ï¼Œå·²ä¿å­˜å½“å‰è¿›åº¦',
                        'timestamp': datetime.now().isoformat(),
                        'max_process_count': max_count,
                        'max_rank_count': max_rank,
                        'force_restart': force_restart
                    }, f, ensure_ascii=False, indent=2)
                
        except Exception as e:
            print(f'âŒ å…³é”®è¯å¤„ç†å¤±è´¥: {str(e)}')
            
            # è®¾ç½®å¤±è´¥çŠ¶æ€
            with open('process_result.json', 'w', encoding='utf-8') as f:
                json.dump({
                    'status': 'error',
                    'error': str(e),
                    'timestamp': datetime.now().isoformat(),
                    'max_process_count': max_count,
                    'max_rank_count': max_rank,
                    'force_restart': force_restart
                }, f, ensure_ascii=False, indent=2)
            
            # é‡æ–°æŠ›å‡ºå¼‚å¸¸ä»¥è§¦å‘é‡è¯•
            raise
        "
        
    - name: æ£€æŸ¥å¤„ç†ç»“æœ
      id: check-result
      if: always()
      run: |
        if [ -f "process_result.json" ]; then
          STATUS=$(python -c "import json; data=json.load(open('process_result.json')); print(data['status'])")
          echo "å¤„ç†çŠ¶æ€: $STATUS"
          echo "status=$STATUS" >> $GITHUB_OUTPUT
          
          if [ "$STATUS" = "error" ]; then
            ERROR_MSG=$(python -c "import json; data=json.load(open('process_result.json')); print(data.get('error', 'Unknown error'))")
            echo "é”™è¯¯ä¿¡æ¯: $ERROR_MSG"
            echo "error_message=$ERROR_MSG" >> $GITHUB_OUTPUT
          elif [ "$STATUS" = "warning" ]; then
            WARNING_MSG=$(python -c "import json; data=json.load(open('process_result.json')); print(data.get('message', 'Unknown warning'))")
            echo "è­¦å‘Šä¿¡æ¯: $WARNING_MSG"
            echo "error_message=$WARNING_MSG" >> $GITHUB_OUTPUT
          elif [ "$STATUS" = "circuit_breaker" ]; then
            CIRCUIT_MSG=$(python -c "import json; data=json.load(open('process_result.json')); print(data.get('message', 'Circuit breaker triggered'))")
            echo "ç†”æ–­ä¿¡æ¯: $CIRCUIT_MSG"
            echo "error_message=$CIRCUIT_MSG" >> $GITHUB_OUTPUT
          fi
        else
          echo "æœªæ‰¾åˆ°å¤„ç†ç»“æœæ–‡ä»¶"
          echo "status=unknown" >> $GITHUB_OUTPUT
        fi
        
    - name: ä¸Šä¼ å¤„ç†æ—¥å¿—
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: keyword-process-logs-${{ github.run_number }}
        path: |
          process_result.json
          *.log
        retention-days: 7
        
    - name: é‡ç½®ä¸ºæ—¥å¸¸è¿è¡Œæ¨¡å¼
      if: steps.check-result.outputs.status == 'success'
      run: |
        echo "âœ… å¤„ç†æˆåŠŸï¼Œé‡ç½®å·¥ä½œæµä¸ºæ—¥å¸¸è¿è¡Œæ¨¡å¼..."
        python update_workflow_schedule.py --type daily
        
        # æäº¤å·¥ä½œæµæ–‡ä»¶æ›´æ”¹
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add .github/workflows/process-keywords.yml
        if git diff --staged --quiet; then
          echo "ğŸ“ å·¥ä½œæµæ–‡ä»¶æœªæ›´æ”¹"
        else
          git commit -m "è‡ªåŠ¨é‡ç½®å·¥ä½œæµä¸ºæ—¥å¸¸è¿è¡Œæ¨¡å¼ (æ¯å¤©åŒ—äº¬æ—¶é—´1ç‚¹)"
          git push
          echo "ğŸ“ å·²æäº¤å·¥ä½œæµæ–‡ä»¶æ›´æ”¹"
        fi
        
    - name: å‘é€æˆåŠŸé€šçŸ¥
      if: steps.check-result.outputs.status == 'success'
      run: |
        echo "ğŸ‰ å…³é”®è¯å¤„ç†æˆåŠŸå®Œæˆï¼"
        echo "è¿è¡Œç¼–å·: ${{ github.run_number }}"
        echo "å®Œæˆæ—¶é—´: $(date)"
        echo "å¤„ç†å…³é”®è¯æ•°é‡: ${{ github.event.inputs.max_process_count || 'æ— é™åˆ¶' }}"
        echo "å¤„ç†æ’è¡Œæ•°é‡: ${{ github.event.inputs.max_rank_count || 'ä½¿ç”¨é»˜è®¤å€¼' }}"
        
    - name: è°ƒæ•´å·¥ä½œæµä¸ºé‡è¯•æ¨¡å¼ (æ™®é€šé”™è¯¯)
      if: steps.check-result.outputs.status == 'error' || steps.check-result.outputs.status == 'warning'
      run: |
        echo "âš ï¸ å¤„ç†å¤±è´¥ï¼Œè°ƒæ•´å·¥ä½œæµä¸ºé‡è¯•æ¨¡å¼ï¼ˆ30åˆ†é’Ÿåé‡è¯•ï¼‰..."
        python update_workflow_schedule.py --type retry --delay 30
        
    - name: è°ƒæ•´å·¥ä½œæµä¸ºç†”æ–­é‡è¯•æ¨¡å¼
      if: steps.check-result.outputs.status == 'circuit_breaker'
      run: |
        echo "ğŸ”¥ ç†”æ–­æœºåˆ¶è§¦å‘ï¼Œè°ƒæ•´å·¥ä½œæµä¸ºç†”æ–­é‡è¯•æ¨¡å¼ï¼ˆ2å°æ—¶åé‡è¯•ï¼‰..."
        python update_workflow_schedule.py --type retry --delay 120
        
        # æäº¤å·¥ä½œæµæ–‡ä»¶æ›´æ”¹
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add .github/workflows/process-keywords.yml
        # æ·»åŠ ä»Šå¤©çš„å·¥ä½œæµè°ƒåº¦æ—¥å¿—æ–‡ä»¶
        TODAY_LOG_DIR="logs/$(date +%Y)/$(date +%m)/$(date +%d)"
        mkdir -p "$TODAY_LOG_DIR"
        git add "$TODAY_LOG_DIR/workflow_schedule_updates.log" 2>/dev/null || echo "æ²¡æœ‰æ‰¾åˆ°ä»Šå¤©çš„è°ƒåº¦æ—¥å¿—æ–‡ä»¶"
        if git diff --staged --quiet; then
          echo "ğŸ“ å·¥ä½œæµæ–‡ä»¶æœªæ›´æ”¹"
        else
          git commit -m "è‡ªåŠ¨è°ƒæ•´å·¥ä½œæµä¸ºç†”æ–­é‡è¯•æ¨¡å¼ (2å°æ—¶åé‡è¯•)"
          git push
          echo "ğŸ“ å·²æäº¤å·¥ä½œæµæ–‡ä»¶æ›´æ”¹"
        fi
        
    - name: å‘é€å¤±è´¥é€šçŸ¥
      if: steps.check-result.outputs.status == 'error' || steps.check-result.outputs.status == 'warning'
      run: |
        echo "âŒ å…³é”®è¯å¤„ç†å¤±è´¥ï¼"
        echo "è¿è¡Œç¼–å·: ${{ github.run_number }}"
        echo "å¤±è´¥æ—¶é—´: $(date)"
        echo "é”™è¯¯ä¿¡æ¯: ${{ steps.check-result.outputs.error_message }}"
        echo "ğŸ• å·²å®‰æ’30åˆ†é’Ÿåé‡è¯•"
        
    - name: å‘é€ç†”æ–­é€šçŸ¥
      if: steps.check-result.outputs.status == 'circuit_breaker'
      run: |
        echo "ğŸ”¥ å…³é”®è¯å¤„ç†è§¦å‘ç†”æ–­æœºåˆ¶ï¼"
        echo "è¿è¡Œç¼–å·: ${{ github.run_number }}"
        echo "ç†”æ–­æ—¶é—´: $(date)"
        echo "ç†”æ–­åŸå› : ${{ steps.check-result.outputs.error_message }}"
        echo "ğŸ• å·²å®‰æ’2å°æ—¶åé‡è¯•ï¼ˆç­‰å¾…APIæœåŠ¡æ¢å¤ï¼‰"
