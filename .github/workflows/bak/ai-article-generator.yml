name: AIæ–‡ç« ç”Ÿæˆå™¨å·¥ä½œæµ

on:
  # ä»…æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      keywords:
        description: 'æ–‡ç« å…³é”®è¯ï¼ˆæ¯è¡Œä¸€ä¸ªï¼Œæ ¼å¼ï¼šå…³é”®è¯----è‡ªå®šä¹‰å°¾è¯----æ¸¸æˆåï¼‰'
        required: true
        default: 'ä¸€å¿µé€é¥é›¶æ°ªç©å®¶ç©ä»€ä¹ˆèŒä¸š----æ— é™é’»çŸ³ç‰ˆ----ä¸€å¿µé€é¥'
        type: string
      platform:
        description: 'AIå¹³å°é€‰æ‹©'
        required: false
        default: 'groq'
        type: choice
        options:
          - groq
          - openai
          - gemini
          - claude
      need_images:
        description: 'æ˜¯å¦éœ€è¦ä¸‹è½½å›¾ç‰‡'
        required: false
        default: true
        type: boolean
      language:
        description: 'ç”Ÿæˆè¯­è¨€'
        required: false
        default: 'both'
        type: choice
        options:
          - both
          - zh-cn
          - zh-tw

  # # å®šæ—¶è§¦å‘ï¼ˆæ¯å¤©ä¸Šåˆ9ç‚¹ï¼‰
  # schedule:
  #   - cron: '0 9 * * *'

  # # æ¨é€åˆ°mainåˆ†æ”¯æ—¶è§¦å‘
  # push:
  #   branches: [ main ]
  #   paths:
  #     - 'é•¿å°¾è¯.txt'
  #     - 'aigen.py'
  #     - 'config.json'

jobs:
  generate-articles:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: åˆ›å»ºé…ç½®æ–‡ä»¶
      run: |
        # åªæœ‰åœ¨config.jsonä¸å­˜åœ¨æ—¶æ‰åˆ›å»ºé…ç½®æ–‡ä»¶
        if [ ! -f "config.json" ]; then
          echo "config.jsonä¸å­˜åœ¨ï¼Œæ­£åœ¨åˆ›å»ºé…ç½®æ–‡ä»¶..."
          cat > config.json << EOF
        {
          "default_platform": "${{ github.event.inputs.platform || 'groq' }}",
          "platforms": {
            "groq": {
              "name": "Groq",
              "base_url": "https://api.groq.com/openai/v1/chat/completions",
              "proxy_url": "https://m3u8-player.5yxy5.com/api/forward/https://api.groq.com/openai/v1/chat/completions",
              "models": {
                "default": "deepseek-r1-distill-llama-70b",
                "available": [
                  "deepseek-r1-distill-llama-70b",
                  "llama-3.1-70b-versatile",
                  "llama-3.1-8b-instant",
                  "mixtral-8x7b-32768"
                ]
              },
              "api_keys": [
                "${{ secrets.GROQ_API_KEY_1 }}",
                "${{ secrets.GROQ_API_KEY_2 }}",
                "${{ secrets.GROQ_API_KEY_3 }}",
                "${{ secrets.GROQ_API_KEY_4 }}",
                "${{ secrets.GROQ_API_KEY_5 }}",
                "${{ secrets.GROQ_API_KEY_6 }}"
              ],
              "headers": {
                "Content-Type": "application/json"
              },
              "auth_type": "bearer",
              "timeout": 60,
              "max_retries": 20
            },
            "openai": {
              "name": "OpenAI",
              "base_url": "https://api.openai.com/v1/chat/completions",
              "proxy_url": "https://m3u8-player.5yxy5.com/api/forward/https://api.openai.com/v1/chat/completions",
              "models": {
                "default": "gpt-3.5-turbo",
                "available": [
                  "gpt-3.5-turbo",
                  "gpt-3.5-turbo-16k",
                  "gpt-4",
                  "gpt-4-turbo",
                  "gpt-4o",
                  "gpt-4o-mini"
                ]
              },
              "api_keys": [
                "${{ secrets.OPENAI_API_KEY }}"
              ],
              "headers": {
                "Content-Type": "application/json"
              },
              "auth_type": "bearer",
              "timeout": 60,
              "max_retries": 20
            },
            "gemini": {
              "name": "Google Gemini",
              "base_url": "https://generativelanguage.googleapis.com/v1beta/models",
              "proxy_url": "https://m3u8-player.5yxy5.com/api/forward/https://generativelanguage.googleapis.com/v1beta/models",
              "models": {
                "default": "gemini-1.5-flash",
                "available": [
                  "gemini-1.5-flash",
                  "gemini-1.5-pro",
                  "gemini-1.0-pro"
                ]
              },
              "api_keys": [
                "${{ secrets.GEMINI_API_KEY }}"
              ],
              "headers": {
                "Content-Type": "application/json"
              },
              "auth_type": "api_key",
              "timeout": 60,
              "max_retries": 20
            },
            "claude": {
              "name": "Anthropic Claude",
              "base_url": "https://api.anthropic.com/v1/messages",
              "proxy_url": "https://m3u8-player.5yxy5.com/api/forward/https://api.anthropic.com/v1/messages",
              "models": {
                "default": "claude-3-sonnet-20240229",
                "available": [
                  "claude-3-sonnet-20240229",
                  "claude-3-opus-20240229",
                  "claude-3-haiku-20240307"
                ]
              },
              "api_keys": [
                "${{ secrets.CLAUDE_API_KEY }}"
              ],
              "headers": {
                "Content-Type": "application/json",
                "anthropic-version": "2023-06-01"
              },
              "auth_type": "x-api-key",
              "timeout": 60,
              "max_retries": 20
            }
          },
          "settings": {
            "use_proxy": true,
            "temperature": 0.6,
            "max_tokens": 10000,
            "top_p": 0.95,
            "stream": false
          },
          "prompts": {
            "zh-cn": {
              "name": "ç®€ä½“ä¸­æ–‡æç¤ºè¯",
              "template": "${{ secrets.ZH_CN_PROMPT_TEMPLATE }}"
            },
            "zh-tw": {
              "name": "ç¹é«”ä¸­æ–‡æç¤ºè©",
              "template": "${{ secrets.ZH_TW_PROMPT_TEMPLATE }}"
            }
          }
        }
        EOF
        else
          echo "config.jsonå·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»ºé…ç½®æ–‡ä»¶"
        fi
        
    - name: åˆ›å»ºå…³é”®è¯è¾“å…¥æ–‡ä»¶
      run: |
        # åˆ›å»ºä¸´æ—¶è¾“å…¥æ–‡ä»¶
        echo "${{ github.event.inputs.keywords || 'ä¸€å¿µé€é¥é›¶æ°ªç©å®¶ç©ä»€ä¹ˆèŒä¸š----æ— é™é’»çŸ³ç‰ˆ----ä¸€å¿µé€é¥' }}" > temp_keywords.txt
        
    - name: è¿è¡ŒAIæ–‡ç« ç”Ÿæˆå™¨
      run: |
        # è®¾ç½®ç¯å¢ƒå˜é‡
        export PYTHONUNBUFFERED=1
        
        # è¿è¡Œæ–‡ç« ç”Ÿæˆå™¨ï¼ˆéäº¤äº’æ¨¡å¼ï¼‰
        python -c "
        import sys
        sys.path.append('.')
        
        # å¯¼å…¥å¿…è¦çš„æ¨¡å—
        from aigen import initialize_managers, process_all_articles, LANGUAGES
        from config_manager import ConfigManager
        from api_manager import MultiPlatformApiManager
        import time
        
        # åˆå§‹åŒ–é…ç½®å’ŒAPIç®¡ç†å™¨
        config_manager, api_manager = initialize_managers()
        
        # è®¾ç½®å¹³å°
        platform = '${{ github.event.inputs.platform || 'groq' }}'
        api_manager.set_platform(platform)
        
        # è¯»å–å…³é”®è¯
        with open('temp_keywords.txt', 'r', encoding='utf-8') as f:
            keywords_input = f.read().strip()
        
        # è§£æå…³é”®è¯
        keywords = [line.strip() for line in keywords_input.split('\n') if line.strip()]
        
        # å‡†å¤‡ç”¨æˆ·è¾“å…¥
        need_images_str = '${{ github.event.inputs.need_images || 'true' }}'
        need_images = need_images_str.lower() == 'true'
        
        user_inputs = {
            'keywords': keywords,
            'prompt_template': config_manager.get_prompt_template('zh-cn'),
            'need_images': need_images,
            'selected_platform': platform
        }
        
        print(f'å¼€å§‹ç”Ÿæˆ {len(keywords)} ç¯‡æ–‡ç« ...')
        print(f'ä½¿ç”¨å¹³å°: {platform}')
        print(f'éœ€è¦å›¾ç‰‡: {user_inputs[\"need_images\"]}')
        
        # å¤„ç†æ‰€æœ‰æ–‡ç« 
        results = process_all_articles(user_inputs)
        
        # è¾“å‡ºç»“æœ
        print('\\n===== ç”Ÿæˆç»“æœæ±‡æ€» =====')
        success_count = sum(1 for r in results if r['status'] == 'æˆåŠŸ')
        fail_count = len(results) - success_count
        
        print(f'æˆåŠŸç”Ÿæˆ: {success_count} ç¯‡')
        print(f'å¤±è´¥: {fail_count} ç¯‡')
        
        # æ˜¾ç¤ºAPIä½¿ç”¨ç»Ÿè®¡
        api_manager.show_usage_stats()
        "
        
    - name: ä¸Šä¼ ç”Ÿæˆçš„æ–‡ç« 
      uses: actions/upload-artifact@v4
      with:
        name: generated-articles-${{ github.run_number }}
        path: assets/
        retention-days: 30
        
    - name: ä¸Šä¼ é”™è¯¯æ—¥å¿—
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: error-logs-${{ github.run_number }}
        path: assets/error_log.txt
        retention-days: 7
        
    - name: æäº¤ç”Ÿæˆçš„æ–‡ç« åˆ°ä»“åº“
      if: success()
      run: |
        # é…ç½®Gitç”¨æˆ·ä¿¡æ¯
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # æ·»åŠ ç”Ÿæˆçš„æ–‡ç« 
        git add assets/
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
        if git diff --staged --quiet; then
          echo "æ²¡æœ‰æ–°çš„æ–‡ç« ç”Ÿæˆ"
        else
          # æäº¤å˜æ›´
          git commit -m "ğŸ¤– è‡ªåŠ¨ç”Ÿæˆæ–‡ç«  - å·¥ä½œæµ #${{ github.run_number }} [skip ci]"
          
          # æ¨é€åˆ°ä»“åº“
          git push
          
          echo "âœ… æ–‡ç« å·²æˆåŠŸæäº¤åˆ°ä»“åº“"
        fi
        
    - name: å‘é€é€šçŸ¥
      if: always()
      run: |
        echo "å·¥ä½œæµæ‰§è¡Œå®Œæˆ"
        echo "è¿è¡Œç¼–å·: ${{ github.run_number }}"
        echo "è§¦å‘æ–¹å¼: ${{ github.event_name }}"
        echo "æäº¤å“ˆå¸Œ: ${{ github.sha }}"
